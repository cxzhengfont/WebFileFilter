<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="../src/images/icon_16px.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>list-test</title>
    <link href="../src/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .pager {
            text-align: right;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="row">
                <div class="col-sm-2 col-md-2 col-lg-2"></div>
                <div class="col-sm-10 col-md-10 col-lg-10">
                    <div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                            data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle
                                navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span
                                class="icon-bar"></span></button></div>
                    <div id="navbar" class="collapse navbar-collapse">
                        <ul class="nav navbar-nav"></ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <div id="nav" class="col-sm-2 col-md-2 col-lg-2">
                <ul class="nav nav-pills nav-stacked"></ul>
            </div>
            <div class="col-sm-10 col-md-10 col-lg-10">
                <table id="table" class="table table-bordered"></table>
                <ul class="pager">
                    <span id="pageIndexSpan" title="页码"></span>&nbsp;/
                    <span id="pageSizeSpan" title="每页条数"></span>&nbsp;/
                    <span id="totalCountSpan" title="总数"></span>&nbsp;
                    <li id="previousPageLi" class="disabled"><a href="javascript:;">上一页</a></li>
                    <li id="nextPageLi"><a href="javascript:;">下一页</a></li>
                </ul>
            </div>
        </div>
    </div>
    <script src="../src/js/jquery.min.js" type="text/javascript"></script>
    <script src="../src/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../src/js/jslinq.js" type="text/javascript"></script>
    <script type="text/javascript">

        var fileList = [];
        fileList.push({ Project: "cmapi", LogDate: "20181112", LogHour: "15.txt", LogChangeTime: "2018-11-12 15:47", LogSize: "10K", FileName: "cmapi-20181112-15.txt" });
        fileList.push({ Project: "portal", LogDate: "20181031", LogHour: "16.txt", LogChangeTime: "2018-10-31 16:27", LogSize: "2721", FileName: "portal-20181031-16.txt" });
        fileList.push({ Project: "portal", LogDate: "20181203", LogHour: "16.txt", LogChangeTime: "2018-12-03 16:47", LogSize: "29K", FileName: "portal-20181203-16.txt" });
        fileList.push({ Project: "portal", LogDate: "20181204", LogHour: "12.txt", LogChangeTime: "2018-12-04 12:26", LogSize: "11", FileName: "portal-20181204-12.txt" });
        fileList.push({ Project: "portal", LogDate: "20181205", LogHour: "11.txt", LogChangeTime: "2018-12-05 11:26", LogSize: "3611", FileName: "portal-20181205-11.txt" });
        fileList.push({ Project: "vfs", LogDate: "20181101", LogHour: "13.txt", LogChangeTime: "2018-11-01 13:54", LogSize: "1", FileName: "vfs-20181101-13.txt" });
        fileList.push({ Project: "vfs", LogDate: "20181207", LogHour: "18.txt", LogChangeTime: "2018-12-07 18:07", LogSize: "5872", FileName: "vfs-20181207-18.txt" });
        fileList.push({ Project: "vfs", LogDate: "20181206", LogHour: "11.txt", LogChangeTime: "2018-12-06 18:07", LogSize: "123", FileName: "vfs-20181206-11.txt" });

        var pageIndex = 1;
        var pageSize = 10;
        var totalCount = fileList.length;
        $("#pageIndexSpan").text(pageIndex);
        $("#pageSizeSpan").text(pageSize);
        $("#totalCountSpan").text(totalCount);


        var pNames = getProjectNames();
        $.each(pNames, function (idx, val) {
            $("#navbar ul").append("<li data-value=\"" + val + "\"><a href='javascript:;'><strong>" + val + "</strong></a></li>");
        });
        if (pNames.length > 0) {
            if (localStorage.pName != undefined && $.inArray(localStorage.pName, pNames) != -1)
                navBarLiClick(localStorage.pName);
            else
                navBarLiClick(pNames[0]);
        }
        else {
            $("body").html('<div class="container"><div class="row"><div class="col-sm-12 col-md-12 col-lg-12"><h3>暂无记录，请稍后刷新重试！</h3></div></div></div>');
        }

        $("body").on("click", "#navbar ul li", function () {
            navBarLiClick($(this).attr("data-value"));
        });

        $("body").on("click", "#nav ul li", function () {
            navLiClick($(this).attr("data-pname"), $(this).attr("data-date"));
        });

        $("body").on("click", "#table tbody tr", function () {
            $(this).css("background", "#DCDCDC").siblings().css("background", "");
        });

        function formatDate(dt) {
            var date = new Date(dt);
            var aaaa = date.getFullYear();
            var gg = date.getDate();
            var mm = (date.getMonth() + 1);

            if (gg < 10) gg = "0" + gg;
            if (mm < 10) mm = "0" + mm;

            var cur_day = aaaa + "-" + mm + "-" + gg;
            var hours = date.getHours()
            var minutes = date.getMinutes()
            //var seconds = date.getSeconds();

            if (hours < 10) hours = "0" + hours;
            if (minutes < 10) minutes = "0" + minutes;
            //if (seconds < 10) seconds = "0" + seconds;

            //return cur_day + " " + hours + ":" + minutes + ":" + seconds;
            return cur_day + " " + hours + ":" + minutes;
        }

        function getProjectNames() {
            return JSLINQ(fileList).Distinct(function () { return this.Project; }).items;
        }

        function getDistinctProjectLogDate(pName) {
            return JSLINQ(fileList).Where(function () { return this.Project == pName; }).Distinct(function () { return this.LogDate; }).items;
        }

        function getProjectLogFiles(pName, logDate) {
            if (logDate == 'all') {
                return JSLINQ(fileList).Where(function () { return this.Project == pName; }).Select("LogDate,LogHour,LogChangeTime,LogSize,FileName").items;
            }
            else {
                return JSLINQ(fileList).Where(function () { return this.Project == pName && this.LogDate == logDate; }).Select("LogDate,LogHour,LogChangeTime,LogSize,FileName").items;
            }
        }

        function navBarLiClick(liPName) {
            $("#navbar ul li[data-value=\"" + liPName + "\"]").addClass("active").siblings().removeClass("active");

            $("#nav ul").empty();
            $("#nav ul").append("<li data-pname=\"" + liPName + "\" data-date=\"all\"><a href='javascript:;'>all</a></li>");

            var liDate = '';
            var list = getDistinctProjectLogDate(liPName);
            //list.sort();
            list.reverse();
            $.each(list, function (i, v) {
                if (localStorage.logDate != undefined && localStorage.pName != undefined && localStorage.pName == liPName && localStorage.logDate == v) {
                    liDate = localStorage.logDate;
                    $("#nav ul").append("<li class='active' data-pname=\"" + liPName + "\" data-date=\"" + v + "\"><a href='javascript:;'>" + v + "</a></li>");
                }
                else {
                    $("#nav ul").append("<li data-pname=\"" + liPName + "\" data-date=\"" + v + "\"><a href='javascript:;'>" + v + "</a></li>");
                }
            });
            if (liDate == '') {
                liDate = 'all';
                $("#nav ul li:first").addClass("active");
            }
            initFileList(liPName, liDate);
        }

        function navLiClick(liPName, liDate) {
            $("#nav ul li[data-date=\"" + liDate + "\"]").addClass("active").siblings().removeClass("active");
            initFileList(liPName, liDate);
        }

        function initFileList(pName, logDate) {
            if (localStorage.pName != pName)
                localStorage.pName = pName;
            if (localStorage.logDate != logDate)
                localStorage.logDate = logDate;

            var fileList = getProjectLogFiles(pName, logDate);
            //fileList.sort();
            fileList.reverse();

            $("#table").empty();
            $("#table").append("<thead><tr><th>文件名</th><th>时间</th><th>大小</th><th>操作</th></tr></thead><tbody>");
            if (fileList.length > 0) {
                $.each(fileList, function (i, v) {
                    $("#table").append("<tr><td>" + v.FileName + "</td><td>" + v.LogChangeTime + "</td><td>" + v.LogSize + "</td><td><a href='" + v.FileName + "' target='_blank'>查看</a></td></tr>");
                });
            }
            else {
                $("#table").append("<tr><td colspan='4'><center>暂无数据</center></td></tr>");
            }
            $("#table").append("</tbody>");
        }
    </script>
</body>

</html>